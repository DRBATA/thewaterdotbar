# The Water Bar – Checkout & PIN-Claim Flow\n\nThis README documents the end-to-end purchase flow and the new staff PIN-claim system that went live on 22 Jun 2025.\n\n---\n## 1. Customer Journey\n1. **Cart → Checkout**\n   * Customers add items to cart (`cart_headers` / `cart_items`).\n   * `POST /api/stripe/checkout` creates a Stripe Checkout Session.\n2. **Payment**\n   * Stripe redirects back to `/success?session=cs_…`.\n3. **Order Creation (Webhook)**\n   * Stripe sends `checkout.session.completed` to `POST /api/stripe/webhook`.\n   * Handler calls the SQL function `migrate_cart_to_order(session_id,text)` which:\n     * Inserts into `orders` and `order_items`.\n     * Generates a **4-digit `pin_code`** for each `order_items` row (column default).\n   * Cart rows are cleared.\n4. **Ticket**\n   * Customer lands on `/success`.\n   * Button “Show Entry Pass” links to `/receipt/[sessionId]`.\n   * Ticket page shows order details **and the PIN** next to each item.\n\n---\n## 2. Staff Redemption Workflow\n1. Browse to **`/claim`** (public but unlinked).\n2. Enter the 4-digit PIN printed on the ticket.\n3. System fetches the matching `order_items` row.\n4. Staff must tick:\n   * “Email confirmed”\n   * “Token / drink handed over”\n5. Press **Complete & mark claimed** → `claimed_at` timestamp is stored.\n6. Attempting the same PIN again returns “Already claimed”.\n\n### API Endpoints\n* `GET  /api/claim/[pin]` → details if not claimed.\n* `POST /api/claim/[pin]` → sets `claimed_at = now()` (service-role).\n\n---\n## 3. Database Schema Changes\n```sql\n-- added 22 Jun 2025\nalter table public.order_items\n  add column pin_code  text not null default (lpad((floor(random()*10000))::int::text,4,'0')),\n  add column claimed_at timestamptz;\ncreate index if not exists order_items_pin_code_idx on public.order_items(pin_code);\n```\n\n* `pin_code` is auto-generated; collision chances are <1% for a few hundred rows.\n* `claimed_at` is NULL until staff complete redemption.\n\nQuery unclaimed items:\n```sql\nselect *\nfrom order_items\nwhere claimed_at is null\norder by created_at desc;\n```\n\n---\n## 4. Environment Variables\n| Variable | Purpose |\n|----------|---------|\n| `NEXT_PUBLIC_SITE_URL` | Base URL used when creating Stripe success/cancel links |\n| `STRIPE_SECRET_KEY` | Live secret key |\n| `STRIPE_WEBHOOK_SECRET` | Live webhook signing secret |\n| `SUPABASE_SERVICE_ROLE_KEY` | Used by `/api/claim` to update `claimed_at` |\n\n---\n## 5. Deploy Notes\n1. Push to `main` → Vercel builds & deploys.\n2. Database migrations run manually in Supabase SQL editor (see `supabase/migrations`).\n3. After env-var changes, always redeploy in Vercel.\n\n---\n## 6. Future Ideas\n* Add UNIQUE constraint to `pin_code` and retry generation on conflict.\n* Export CSV of claimed/unclaimed items for on-site ops.\n* QR-code on ticket pointing to `/receipt/[sessionId]`.\n
